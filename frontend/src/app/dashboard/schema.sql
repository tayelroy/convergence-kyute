-- Create the funding_rates table
create table public.funding_rates (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  timestamp timestamptz not null,
  asset_symbol text not null,
  median_apr numeric,
  binance_rate numeric,
  hyperliquid_rate numeric,
  boros_rate numeric default 0,
  spread_bps numeric
);

-- Enable Row Level Security
alter table public.funding_rates enable row level security;

-- Policy: Allow public read access (for Dashboard)
create policy "Allow public read access"
on public.funding_rates for select
to anon
using (true);

-- Policy: Allow anonymous inserts (for Demo/Workflow)
-- CAUTION: In production, use service_role key instead of allowing anon inserts
create policy "Allow anon insert"
on public.funding_rates for insert
to anon
with check (true);

-- Optional: Realtime
begin;
  -- remove the supabase_realtime publication
  drop publication if exists supabase_realtime;
  -- re-create the publication but don't enable it for any tables
  create publication supabase_realtime;
commit;

-- Add table to realtime publication
alter publication supabase_realtime add table public.funding_rates;
